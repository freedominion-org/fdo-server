#!/bin/sh

#### Recipe Variable Definitions ###############################################
RECIPE_JAIL_IP="${JAILS_LAN_SUBNET_C}.30"                                      # Optional:  ip address given to the jail (see FDo IP Policy).
RECIPE_PACKAGES="www/nginx"                                                    # Optional:  packages to install in the jail.
RECIPE_COMPAT=1                                                                # Mandatory: Compatability level indicator.
RECIPE_REQUIRES_JAIL_RESTART="no"                                              # Mandatory: "yes" if the jail requires a restart after cooking.
RECIPE_REQUIRES_PORT_FORWARD="yes"                                             # Mandatory: "yes" if the hosts NAT (pf/ppp) requires a restart after cooking.
RECIPE_REQUIRES_HTTP_GATEWAY="no"                                              # Mandatory:  whether this recipe requires an http gateway site.
RECIPE_REQUIRES_DNS_HOSTNAME="no"                                              # Mandatory:  whether his recipe requires a caching DNS hostname override.
RECIPE_TCP_PORTS="80,443"                                                      # Optional:  tcp ports to forward, necessary for port forwarding.
RECIPE_UDP_PORTS="none"                                                        # Optional:  udp ports to forward, necessary for port forwarding.
START_JAIL_SERVICES="nginx"                                                    # Optional:  jail services started after cooking (in left to right order).
SIDES_FILESYSTEMS=""                                                           # Optional:  names of additional ZFS filesystems required for recipe.
SIDES_MOUNTPOINTS=""                                                           # Optional:  mountpoints of additional ZFS filesystems required for recipe.
NOHOST_CERT_FILE="/usr/local/etc/ssl/fdo-certs/nohost.pem"                     #
################################################################################

prep_recipe ()
{
	PREP_SUCCESS="yes"
}

cook_recipe ()
{

	## TODO: ask for number of worker processes.
	WORKER_PROCESSES=`sysctl hw.ncpu | awk '{print $2}'`

	# Replace variables in nginx.conf file.
	sed -i "" "s/WORKER_PROCESSES/${WORKER_PROCESSES}/" configs/${JAIL_NAME}@${HOST_NAME}/usr/local/etc/nginx/nginx.conf
	ERROR_COUNT=$(( ${ERROR_COUNT} + ${?} ))
	if [ ${ERROR_COUNT} -ne 0 ]
	then
		echo -e "\n${LRED}ERROR:${NRML} Failed trying to update nginx.conf.\n"
		RECIPE_SUCCESS="no"
		return
	fi

	# Replace variables in hosts file.
	sed -i "" "s/JAIL_IP/${JAIL_IP}/" configs/${JAIL_NAME}@${HOST_NAME}/etc/hosts
	ERROR_COUNT=$(( ${ERROR_COUNT} + ${?} ))
	sed -i "" "s/JAIL_HOST_NAME/${JAIL_HOST_NAME}/" configs/${JAIL_NAME}@${HOST_NAME}/etc/hosts
	ERROR_COUNT=$(( ${ERROR_COUNT} + ${?} ))
	if [ ${ERROR_COUNT} -ne 0 ]
	then
		echo -e "\n${LRED}ERROR:${NRML} Failed trying to update the jails' hosts file.\n"
		RECIPE_SUCCESS="no"
		return
	fi

	openssl req -new -newkey rsa:1024 -days 3650 -nodes -x509 -subj "/C=ZZ/ST=None/L=None/O=None/CN=nohost" -keyout ${NOHOST_CERT_FILE} -out ${NOHOST_CERT_FILE}

	# Mandatory: return code.
	RECIPE_SUCCESS="yes"

}
